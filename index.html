
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Raytracer</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <style>
          @font-face {
      font-family: "GeoSans";
      src: url("GeosansLight.ttf");
    }
    
      html{ color:#fff; background:#000; font-family:"GeoSans"; overflow:hidden }
			body {
				color: #ffffff;
				
				background-color: #ffffff;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}


            #description{

              position:absolute;
              left:0px;
              width:400px;
              padding:10px;
              font-size:20px;

            }

            a{
              color: #fff;
              z-index: 999;
              //bottom:5px;
              //right:10px;
              text-decoration:none;
              //underline:none;
              opacity:.5;
              font-size: 20px;
            }

            a:hover{

              text-decoration:underline;
              opacity:1;

            }

            #gui{
              position:absolute;
              right:0px;
              top:0px;
            }
		</style>
	</head>
	<body>

      <div id="description">

        Raytracing example using <a href="https://www.shadertoy.com/view/ldX3Ws" target="_blank"> This shader by IQ </a>.<br/><br/>
        Because it is a fragment shader, the size of your window will greatly affect the speed of the program. If it is too slow for your liking, drag to resize. The faster the frame rate is ( bottom right corner ), the more you will be able to see the audio reactivity.<br/><br/>
        If you have a <a href="https://www.leapmotion.com/" target="_blank" >Leap Motion Controller</a>, hold space while moving your hand to play with parameters. Release space to set them. If you get too lost, dont feel scared to press 'reset'.<br/><br/>

        Press 'x' to toggle info.
        <br/><br/>

        <a href="https://soundcloud.com/pamparecords/dave-dk-woolloomooloo-1?in=pamparecords/sets/pampa020-ricosh-i-dave-dk" target="_blank">
          Dave DK - Woolloomooloo
        </a>

      </div>


        <div id="gui"></div>

		<div id="container"></div>

		<script src="three.js"></script>
		<script src="stats.min.js"></script>
		<script src="leap.min.js"></script>
		<script src="jquery.min.js"></script>
        <script src="dat.gui.min.js"></script>
		<script src="underscore.js"></script>
		<script src="ShaderLoader.js"></script>
		<script src="AudioController.js"></script>
		<script src="AudioTexture.js"></script>
		<script src="UserAudio.js"></script>
		<script src="Stream.js"></script>

  		<script>

			var container, stats;

            var camera, scene, renderer;

            var controller , frame;

            var velocities = { type:"v3v" , value:[] }
            var spheres = { type:"v3v" , value:[] }
            var sphereCols = { type:"v3v" , value:[] }
            var time = { type:"f" , value:0}
            var uniforms;

            var loaded = 0;
            var neededToLoad = 1;

            var attractionPoint = new THREE.Vector3();

            var gui = new dat.GUI({ autoPlace: false });

var customContainer = document.getElementById('gui');
customContainer.appendChild(gui.domElement);

            var tV3 = new THREE.Vector3();

            var settingParams = false;


            var U = {


              baseAmount:{type:"f",value:.2},
              aoAmount:{type:"f",value:4.},
              radiusBase:{type:"f",value:.009},
              radiusPower:{type:"f",value:3.},
              radiusMultiplier:{type:"f",value:.7},
              attactionPoint:{ type:"v3" , value:attractionPoint },
              springDistance:{type:"f" , value:1 },
              springPower:{type:"f" , value:.0001 },
              attractionPower:{type:"f" , value:.001 },
              attractionDistance:{type:"f" , value:.8 },
              dampening:{type:"f" , value:.95},

              reset:function(){

                for( var i in startingValues ){

                  U[i].value = startingValues[i]

                }


              }
              

            }


            var startingValues = {}
            for( var i in U ){

              startingValues[i] = U[i].value;

            }

            gui.add( U.baseAmount , 'value' , 0 , 1 ).name( 'Base Amount' ).listen();
            gui.add( U.aoAmount , 'value' , 0 , 5 ).name( 'AO Amount' ).listen();
            gui.add( U.radiusBase , 'value' , 0 , .1 ).name( 'Radius Base' ).listen();
            gui.add( U.radiusMultiplier , 'value' , 0 , 4. ).name( 'Radius Multiplier' ).listen();
            gui.add( U.radiusPower , 'value' , 0 , 5 ).name( 'Radius Power' ).listen();
            
            
            gui.add( U.springPower , 'value' , 0 , .001 ).name( 'Spring Power' ).listen();
            gui.add( U.springDistance , 'value' , 0 , 2 ).name( 'Spring Distance' ).listen();
            gui.add( U.attractionDistance , 'value' , 0 , 3 ).name( 'Attraction Distance' ).listen();
            gui.add( U.attractionPower , 'value' , .005 , .1 ).name( 'Attraction Power' ).listen();
            gui.add( U.dampening, 'value' , .8 , 1 ).name( 'Dampening' ).listen();


            gui.add( U , 'reset' );


            var audioController = new AudioController();
            /*var userAudio = new UserAudio( audioController );

            audioController.mute.gain.value = 0;
            userAudio.onStreamCreated = function(){
              onLoad();
            }*/

            var stream = new Stream( 'wool.mp3' , audioController );

            var shaders = new ShaderLoader('shaders');

            
            shaders.load('vs-raytrace','raytrace','vertex' );
            shaders.load('fs-raytrace','raytrace','fragment' );

            shaders.shaderSetLoaded = function(){ 
            

              onLoad();

            }
            
			function init() {

				container = document.getElementById( 'container' );

                controller  = new Leap.Controller();

				camera = new THREE.Camera();
                camera.position.z = 1;

              

				scene = new THREE.Scene();

				var geometry = new THREE.PlaneGeometry( 2, 2 );

                var texture = THREE.ImageUtils.loadTexture( 'moss.jpg' );

                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;


                uniforms = {
                  time: time,
                  resolution: { type: "v2", value: new THREE.Vector2() },
                  mouse:{ type:"v2", value: new THREE.Vector2() },
                  spheres:spheres,
                  sphereCols:sphereCols,
                  texture: { type:"t" , value: texture },
                  t_audio: { type:"t" , value: audioController.texture},
                  baseAmount: U.baseAmount,
                  aoAmount: U.aoAmount,
                  radiusPower: U.radiusPower,
                  radiusMultiplier: U.radiusMultiplier,
                  radiusBase: U.radiusBase,
                };


                var cols = [

                  new THREE.Vector3( 1. , .8 , .3),
                  new THREE.Vector3( .6 , .4 , 1.),
                  new THREE.Vector3( .1 , 1. , .6)
                  ]


                spheres.value.push( attractionPoint );
                for( var i = 0; i < 25; i++ ){

                  if( i != 0 ){

                    var s = new THREE.Vector3(
                      (Math.random() - .5 ) * 3,
                      (Math.random() - .5 ) * 3,
                      (Math.random() - .5 ) * 3
                     // Math.random()
                    );

                    spheres.value.push( s );

                  }

                  var v = new THREE.Vector3(

                    (Math.random() - .5 ) * .03,
                    (Math.random() - .5 ) * .03,
                    (Math.random() - .5 ) * .03

                  );

                  velocities.value.push( v );



                  var c = cols[ Math.floor( Math.random() * cols.length)];
                  sphereCols.value.push( c );

                }


				var material = new THREE.ShaderMaterial( {
                  uniforms: uniforms,
                  vertexShader: shaders.vertexShaders.raytrace,
                  fragmentShader: shaders.fragmentShaders.raytrace
                } );

				var mesh = new THREE.Mesh( geometry, material );
				scene.add( mesh );

                renderer = new THREE.WebGLRenderer({clearColor:0xffffff});
				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.right = '0px';
                stats.domElement.style.bottom = '0px';
                stats.domElement.id="stats";
				container.appendChild( stats.domElement );

				onWindowResize();

				window.addEventListener( 'resize', onWindowResize, false );
				window.addEventListener( 'mousemove', onMouseMove, false );
				window.addEventListener( 'keydown', onKeyDown, false );
				window.addEventListener( 'keyup', onKeyUp, false );

                controller.connect();

			}

			function onWindowResize( event ) {

              var dpr = window.devicePixelRatio || 1;
              uniforms.resolution.value.x = window.innerWidth * dpr;
              uniforms.resolution.value.y = window.innerHeight * dpr;

              renderer.setSize( window.innerWidth, window.innerHeight );

            }

            function onMouseMove( event ) {

			//	uniforms.mouse.value.x = event.clientX;
			//	uniforms.mouse.value.y = event.clientY;


          }

          function onKeyDown( event ) {

            console.log(event.keyCode );

            if( event.keyCode === 88 ){

              toggleView();

            }
            if( event.keyCode === 32 ){
              settingParams = true;
            }
			//	uniforms.mouse.value.x = event.clientX;
			//	uniforms.mouse.value.y = event.clientY;

          }



          function onKeyUp( event ) {

            if( event.keyCode === 32 ){
              settingParams = false;
            }
			//	uniforms.mouse.value.x = event.clientX;
			//	uniforms.mouse.value.y = event.clientY;


		  }



          function toggleView(){

            /*var v = document.getElementById('gui');
            var d = v.style.display;
            if( d !== 'none' ){
              v.style.display = 'none';
            }else{
              v.style.display = 'block';
            }

            
            var v = document.getElementById('stats');
            var d = v.style.display;
            if( d !== 'none' ){
              v.style.display = 'none';
            }else{
              v.style.display = 'block';
            }*/

            var v = document.getElementById('description');
            var d = v.style.display;
            if( d !== 'none' ){
              v.style.display = 'none';
            }else{
              v.style.display = 'block';
            }




          }


			//

			function animate() {

              frame = controller.frame();
              requestAnimationFrame( animate );

              audioController.update();

              for( var i = 0; i < velocities.value.length; i++ ){

                var p = spheres.value[i];
                var v = velocities.value[i];



                tV3.copy( attractionPoint );
                tV3.sub( p );

                var l = tV3.length();

                l -= U.attractionDistance.value;

                l *= l * l;
                tV3.normalize().multiplyScalar( l * U.attractionPower.value );
                v.add( tV3 );


                for( var j = 0; j < velocities.value.length; j++ ){

                  tV3.copy( spheres.value[j] );
                  tV3.sub( p );


                  var l = tV3.length();

                  l -= U.springDistance.value;

                  tV3.normalize().multiplyScalar( l * U.springPower.value );
                  v.add( tV3 );
                  

                }



              }


              for( var i = 0; i < velocities.value.length; i++ ){


                var v = velocities.value[i];
                var p = spheres.value[i];

                p.add( v );
                v.multiplyScalar( U.dampening.value );

              }

                var t = time.value;


              var z = Math.cos( (t * Math.sin( 4+.33)) * .2  );
              var y = Math.cos( (t * Math.sin( 4*3+4.33)) * .2  );
              var x = Math.sin( (t * Math.cos( 4+.33)) * .4  );

              attractionPoint.set( 0 , 0 , 0 );


              if( frame.hands[0] && settingParams === true ){

                var pos = frame.hands[0].palmPosition;
                var center = frame.interactionBox.normalizePoint( pos );
                var rot = frame.hands[0].palmNormal;
                var arm = frame.interactionBox.normalizePoint( frame.hands[0].arm.prevJoint );

                var armN = frame.interactionBox.normalizePoint( frame.hands[0].arm.nextJoint );

                arm[0] -= armN[0];
                arm[1] -= armN[1];
                arm[2] -= armN[2];
                center[0] -= .5;
                center[1] -= .5;
                center[2] -= .5;
                //attractionPoint.x = center[0] * 4;
                //attractionPoint.y = center[1] * 4;
                //attractionPoint.z = center[2] * 1;


                console.log( frame.hands[0] );
                //console.log( rot );
                U.radiusMultiplier.value  = Math.abs( center[0] * 4   );
                U.springDistance.value    = Math.abs( center[1] * 4   );
                U.springPower.value       = Math.abs( center[2] /1500 );

                U.baseAmount.value = Math.abs( rot[0] * (2 ) );
                U.aoAmount.value = 0 + Math.abs( rot[1] * (2 ) );
                U.radiusBase.value = 0 + Math.abs( rot[2] *.10  );


                U.baseAmount.value = Math.abs( rot[0] * (2 ) );
                U.aoAmount.value = 0 + Math.abs( rot[1] * (2 ) );
                U.radiusBase.value = 0 + Math.abs( rot[2] *.10  );

                U.attractionDistance.value = 3. *  Math.abs(Math.sin( arm[0] * 5.));
                U.attractionPower.value =   .1 *Math.abs(Math.sin(  arm[1] ));
                //U.dampening.value =           Math.abs(Math.sin(  arm[2] ));

              }


              stats.update();

              time.value += 0.05;

              for( var  i = 0; i < 25; i++ ){

                
  //spheres.value[i].w = .1 + .03 * Math.sin( ( (i+5) * uniforms.time.value ) / 100 );


              }


              renderer.render( scene, camera );

			}

            

            function onLoad(){


              loaded ++;

              console.log(loaded );
              if( loaded === neededToLoad ){

                init();
                animate();
                
                if( stream.play ){ 
                  stream.play();
                }

              }

            }




		</script>

	</body>
</html>

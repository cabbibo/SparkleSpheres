
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - shader [Monjori]</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #ffffff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;

				background-color: #ffffff;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {

				color: #ffffff;
			}

			#oldie a { color:#da0 }
		</style>
	</head>
	<body>

		<div id="container"></div>

		<script src="three.js"></script>
		<script src="stats.min.js"></script>
		<script src="leap.min.js"></script>
		<script src="jquery.min.js"></script>
        <script src="dat.gui.min.js"></script>
		<script src="underscore.js"></script>
		<script src="ShaderLoader.js"></script>
		<script src="AudioController.js"></script>
		<script src="AudioTexture.js"></script>
		<script src="UserAudio.js"></script>

  		<script>

			var container, stats;

            var camera, scene, renderer;

            var controller , frame;

            var velocities = { type:"v3v" , value:[] }
            var spheres = { type:"v3v" , value:[] }
            var sphereCols = { type:"v3v" , value:[] }
            var time = { type:"f" , value:0}
            var uniforms;

            var loaded = 0;
            var neededToLoad = 2;

            var attractionPoint = new THREE.Vector3();

            var gui = new dat.GUI();

            var tV3 = new THREE.Vector3();


            var U = {


              baseAmount:{type:"f",value:.2},
              aoAmount:{type:"f",value:4.},
              radiusBase:{type:"f",value:.009},
              radiusPower:{type:"f",value:3.},
              radiusMultiplier:{type:"f",value:.7},
              attactionPoint:{ type:"v3" , value:attractionPoint },
              springDistance:{type:"f" , value:1 },
              springPower:{type:"f" , value:.0001 },
              attractionPower:{type:"f" , value:.001 },
              attractionDistance:{type:"f" , value:.8 },
              dampening:{type:"f" , value:.95}


            }
            gui.add( U.baseAmount , 'value' , 0 , 1 ).name( 'Base Amount' );
            gui.add( U.aoAmount , 'value' , 0 , 5 ).name( 'AO Amount' );
            gui.add( U.radiusBase , 'value' , 0 , .1 ).name( 'Radius Base' );
            gui.add( U.radiusMultiplier , 'value' , 0 , 4. ).name( 'Radius Multiplier' );
            gui.add( U.radiusPower , 'value' , 0 , 5 ).name( 'Radius Power' );
            
            
            gui.add( U.springPower , 'value' , 0 , .001 ).name( 'Spring Power' );
            gui.add( U.springDistance , 'value' , 0 , 2 ).name( 'Spring Distance' );
            gui.add( U.attractionDistance , 'value' , 0 , 3 ).name( 'Attraction Distance' );
            gui.add( U.attractionPower , 'value' , .005 , .1 ).name( 'Attraction Power' );
            gui.add( U.dampening, 'value' , .8 , 1 ).name( 'Dampening' );
            



            var audioController = new AudioController();
            var userAudio = new UserAudio( audioController );

            audioController.mute.gain.value = 0;
            userAudio.onStreamCreated = function(){
              onLoad();
            }

            var shaders = new ShaderLoader('shaders');

            
            shaders.load('vs-raytrace','raytrace','vertex' );
            shaders.load('fs-raytrace','raytrace','fragment' );

            shaders.shaderSetLoaded = function(){ 
            

              onLoad();

            }
            
			function init() {

				container = document.getElementById( 'container' );

                controller  = new Leap.Controller();

				camera = new THREE.Camera();
                camera.position.z = 1;

              

				scene = new THREE.Scene();

				var geometry = new THREE.PlaneGeometry( 2, 2 );

                var texture = THREE.ImageUtils.loadTexture( 'moss.jpg' );

                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;


                uniforms = {
                  time: time,
                  resolution: { type: "v2", value: new THREE.Vector2() },
                  mouse:{ type:"v2", value: new THREE.Vector2() },
                  spheres:spheres,
                  sphereCols:sphereCols,
                  texture: { type:"t" , value: texture },
                  t_audio: { type:"t" , value: audioController.texture},
                  baseAmount: U.baseAmount,
                  aoAmount: U.aoAmount,
                  radiusPower: U.radiusPower,
                  radiusMultiplier: U.radiusMultiplier,
                  radiusBase: U.radiusBase,
                };


                var cols = [

                  new THREE.Vector3( 1. , .8 , .3),
                  new THREE.Vector3( .6 , .4 , 1.),
                  new THREE.Vector3( .1 , 1. , .6)
                  ]


                spheres.value.push( attractionPoint );
                for( var i = 0; i < 25; i++ ){

                  if( i != 0 ){

                    var s = new THREE.Vector3(
                      (Math.random() - .5 ) * 3,
                      (Math.random() - .5 ) * 3,
                      (Math.random() - .5 ) * 3
                     // Math.random()
                    );

                    spheres.value.push( s );

                  }

                  var v = new THREE.Vector3(

                    (Math.random() - .5 ) * .03,
                    (Math.random() - .5 ) * .03,
                    (Math.random() - .5 ) * .03

                  );

                  velocities.value.push( v );



                  var c = cols[ Math.floor( Math.random() * cols.length)];
                  sphereCols.value.push( c );

                }


				var material = new THREE.ShaderMaterial( {
                  uniforms: uniforms,
                  vertexShader: shaders.vertexShaders.raytrace,
                  fragmentShader: shaders.fragmentShaders.raytrace
                } );

				var mesh = new THREE.Mesh( geometry, material );
				scene.add( mesh );

                renderer = new THREE.WebGLRenderer({clearColor:0xffffff});
				container.appendChild( renderer.domElement );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				onWindowResize();

				window.addEventListener( 'resize', onWindowResize, false );
				window.addEventListener( 'mousemove', onMouseMove, false );

                controller.connect();

			}

			function onWindowResize( event ) {

              var dpr = window.devicePixelRatio || 1;
              uniforms.resolution.value.x = window.innerWidth * dpr;
              uniforms.resolution.value.y = window.innerHeight * dpr;

              renderer.setSize( window.innerWidth, window.innerHeight );

            }

            function onMouseMove( event ) {

			//	uniforms.mouse.value.x = event.clientX;
			//	uniforms.mouse.value.y = event.clientY;


			}



			//

			function animate() {

              frame = controller.frame();
              requestAnimationFrame( animate );

              audioController.update();

              for( var i = 0; i < velocities.value.length; i++ ){

                var p = spheres.value[i];
                var v = velocities.value[i];



                tV3.copy( attractionPoint );
                tV3.sub( p );

                var l = tV3.length();

                l -= U.attractionDistance.value;

                l *= l * l;
                tV3.normalize().multiplyScalar( l * U.attractionPower.value );
                v.add( tV3 );


                for( var j = 0; j < velocities.value.length; j++ ){

                  tV3.copy( spheres.value[j] );
                  tV3.sub( p );


                  var l = tV3.length();

                  l -= U.springDistance.value;

                  tV3.normalize().multiplyScalar( l * U.springPower.value );
                  v.add( tV3 );
                  

                }



              }


              for( var i = 0; i < velocities.value.length; i++ ){


                var v = velocities.value[i];
                var p = spheres.value[i];

                p.add( v );
                v.multiplyScalar( U.dampening.value );

              }

              if( frame.hands[0] ){

                var pos = frame.hands[0].palmPosition;
                var center = frame.interactionBox.normalizePoint( pos );
                attractionPoint.x = center[0] * 4;
                attractionPoint.y = center[1] * 4;
                attractionPoint.z = center[2] * 1;
                /*for( var i = 0; i < frame.fingers.length; i++ ){

                  var finger = frame.fingers[i];
                  for( var j = 0; j < finger.bones.length; j++ ){

                    var pos = finger.bones[j].prevJoint;

                    var nP = frame.interactionBox.normalizePoint( pos );

                    var index = i * (finger.bones.length+1) + j;

                    spheres.value[ index ].x = nP[0]*2;
                    spheres.value[ index ].y = nP[1]*2;
                    spheres.value[ index ].z = (nP[2]*2) - 1;
                    spheres.value[index].w = .1;

                    if( j == 3 ){

                      var pos = finger.bones[j].nextJoint;

                      var nP = frame.interactionBox.normalizePoint( pos );

                      var index = i * (finger.bones.length+1) + j+1;

                      spheres.value[ index ].x = nP[0]*2;
                      spheres.value[ index ].y = nP[1]*2;
                      spheres.value[ index ].z = (nP[2]*2)-1;

                    }


                  }

                }*/


              }else{


                attractionPoint.set( 0 , 0 , 0 );
               /* for( var i = 0; i < spheres.value.length; i++ ){

                  var l = spheres.length;
                  var t = time.value;

                  //var x = Math.sin( t * (i+1) ) * Math.cos( t * ( l - i +1))*2;
                  
                  //var y = Math.cos( t * (i+1) ) * Math.cos( t * ( l - i +4))*2;
                  var z = Math.cos( (t * Math.sin( i+.33)) * .2  );
                  var y = Math.cos( (t * Math.sin( i*3+4.33)) * .2  );
                  var x = Math.sin( (t * Math.cos( i+.33)) * .4  );

                  //spheres.value[i].x = x;
                  //spheres.value[i].y = y;
                  //spheres.value[i].z = z;

                  spheres.value[i].x = x* .5;//((i / spheres.value.length) - .5)*3;
                  spheres.value[i].y = y*.5;
                  spheres.value[i].z = z*.5;


                }*/

              }

              stats.update();

              time.value += 0.05;

              for( var  i = 0; i < 25; i++ ){

                
  //spheres.value[i].w = .1 + .03 * Math.sin( ( (i+5) * uniforms.time.value ) / 100 );


              }


              renderer.render( scene, camera );

			}

            

            function onLoad(){


              loaded ++;

              console.log(loaded );
              if( loaded === neededToLoad ){

                init();
                animate();
                
                if( stream.play ){ 
                  stream.play();
                }

              }

            }




		</script>

	</body>
</html>
